name: Generate JSON Files

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Version tag for the generated files (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write  # Needed for pushing to versions branch

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for all branches
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml requests python-dotenv
        
    - name: Create output directories
      run: |
        mkdir -p layers
        mkdir -p styles
        mkdir -p temp_versions/${{ github.event.inputs.version_tag }}
        
    - name: Set up environment variables
      env:
        BITBUCKET_USERNAME: ${{ secrets.BITBUCKET_USERNAME }}
        BITBUCKET_TOKEN: ${{ secrets.BITBUCKET_TOKEN }}
        LAYERDIR: ./layers
        STYLEDIR: ./styles
      run: |
        echo "BITBUCKET_USERNAME=$BITBUCKET_USERNAME" >> .env
        echo "BITBUCKET_TOKEN=$BITBUCKET_TOKEN" >> .env
        echo "LAYERDIR=$LAYERDIR" >> .env
        echo "STYLEDIR=$STYLEDIR" >> .env
        
    - name: Run Python scripts
      run: |
        python create_forecast_layers.py
        python create_forecast_styles.py
        
    - name: Copy files to versioned directory
      run: |
        cp layers/*.json temp_versions/${{ github.event.inputs.version_tag }}/
        cp styles/*.json temp_versions/${{ github.event.inputs.version_tag }}/
        echo "${{ github.event.inputs.version_tag }}" > temp_versions/${{ github.event.inputs.version_tag }}/version.txt
        echo "$(date -u '+%Y-%m-%dT%H:%M:%SZ')" > temp_versions/${{ github.event.inputs.version_tag }}/generated_at.txt
        
    - name: Store version in versions branch
      run: |
        # Configure git
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        
        # Save current branch name
        CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
        
        # Clean and create a temporary directory for versions branch
        rm -rf .git/versions-branch || true
        mkdir -p .git/versions-branch
        
        # Try to fetch the versions branch
        if git fetch origin versions; then
          # Branch exists, clone it to a separate directory
          git worktree add .git/versions-branch versions
        else
          # Create new orphan branch
          git worktree add --detach .git/versions-branch
          cd .git/versions-branch
          git checkout --orphan versions
          git rm -rf .
          echo "# Generated Versions" > README.md
          git add README.md
          git commit -m "Initialize versions branch"
          cd ../..
        fi
        
        # Copy new version files
        cd .git/versions-branch
        mkdir -p ${{ github.event.inputs.version_tag }}
        cp -r ../../temp_versions/${{ github.event.inputs.version_tag }}/* ${{ github.event.inputs.version_tag }}/
        
        # Add and commit
        git add ${{ github.event.inputs.version_tag }}
        git commit -m "Add version ${{ github.event.inputs.version_tag }}"
        git push origin versions
        cd ../..
        
        # Clean up
        git worktree remove .git/versions-branch
        git checkout $CURRENT_BRANCH
        
    - name: Upload current files
      uses: actions/upload-artifact@v4
      with:
        name: json-files-current
        path: |
          layers/*.json
          styles/*.json
        
    - name: Upload versioned files
      uses: actions/upload-artifact@v4
      with:
        name: json-files-${{ github.event.inputs.version_tag }}
        path: temp_versions/${{ github.event.inputs.version_tag }}
        retention-days: 90 